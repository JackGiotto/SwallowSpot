{% extends "layout.html" %}

{% block content %}

<script src="{{ url_for('static', filename = 'js/profile_actions.js') }}"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>

<div class="profile-out">
    <span id="notAccessed">
        <h1>Non hai ancora eseguito l'accesso!</h1>
        <a href="{{ url_for('auth.login') }}" class="btn btn-primary btn-lg">Accedi</a>
    </span>
    <div id="profile">
        <h1>Profilo di <strong>{{ username }}</strong>!</h1>
        <!--change username-->
        <button type="button" class="btn btn-primary btn-lg mt-4" onclick="showSection('changeName')">Modifica nome utente</button>
        <form action="{{url_for('profile.user')}}" method="POST">
            <div class="dismissDefault" id="changeName">
                <div class="input-group mb-2 mt-2">
                    <input name="new_username" type="text" class="form-control" placeholder="Nuovo nome utente">
                </div>
                <button type="button" class="btn btn-secondary" onclick="dismissSection('changeName')">Annulla</button>
                <button type="submit" class="btn btn-success">Conferma</button>
            </div>
        </form>
        <!--change zone-->
        <button type="button" class="btn btn-primary btn-lg mt-4" onclick="showSection('changeZone')">Modifica residenza</button>
        <form action="{{url_for('profile.user')}}" method="POST">
        <div class="dismissDefault" id="changeZone">
            <div class="input-group mb-2 mt-2">
                <select id="city" name="city" class="form-select mb-3" aria-label="Select you region">
                    {% for element in cities %}
                        <option value="{{ element['ID_city']}} ">{{ element['city_name'] }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="button" class="btn btn-secondary" onclick="dismissSection('changeZone')">Annulla</button>
            <button type="submit" class="btn btn-success">Conferma</button>
        </form>
        </div>
        <!--change password-->
        <button type="button" class="btn btn-primary btn-lg mt-4" onclick="showSection('changePsw')">Modifica password</button>
        <div class="dismissDefault" id="changePsw">
        <form action="{{url_for('profile.user')}}" method="POST">
            <div class="input-group mb-2 mt-2">
                    <input name="new_password" type="password" class="form-control" onkeyup="check_password()" id="textPassword" placeholder="Nuova password" aria-describedby="confirmPsw1">
                    <button class="btn btn-outline-primary" type="button" id="showPasswordToggle1"><i class="fa-solid fa-eye"></i></button>                
                {{msg}}
            </div>
            <div class="input-group mb-2">
                <input type="password" class="form-control" id="textPassword2" onkeyup="check_password()" uplaceholder="Conferma nuova password" aria-describedby="confirmPsw2">
                <button class="btn btn-outline-primary" type="button" id="showPasswordToggle2"><i class="fa-solid fa-eye"></i></button>
                <span class="input-group-text" id="confirmPsw2">
                    <i class="fa-solid fa-xmark"></i>
                </span>
            </div>
            <button type="button" class="btn btn-secondary" onclick="dismissSection('changePsw')">Annulla</button>
            <button type="submit" class="btn btn-success">Conferma</button>
        </form>
        </div>
        <!--allow notifications-->
        <!--logout-->
        <button type="button" class="btn btn-danger btn-lg mt-4" onclick="logout()">Logout</button>
        <div class="visual-out mt-5">
            <label class="switch3">
                <input type="checkbox" id="toggleNotif" checked />
                <span class="slider3"></span>
            </label>
            <p>Notifiche: <span id="notificationStatus">SI</span></p>
        </div>
        <br>
        <br>
        <!--delete my account-->
        <button type="button" class="btn btn-danger btn-lg mt-4" id="deleteProfile" onclick="showSection('deleteAccount')">Elimina profilo</button>
        <form name="delete_account" action="{{url_for('profile.user')}}" method="POST">
            <div class="dismissDefault" id="deleteAccount">
                <div class="input-group mb-2 mt-2">
                    <input type="text" class="form-control" placeholder="Nome utente">
                </div>
                <div class="input-group mb-2">
                    <input type="password" class="form-control" id="psw3" placeholder="Inserisci password">
                </div>
            </div>
        </form>
    </div>
</div>

<div class="visual-mode">
    <h2>Modifica il tema di visualizzazione</h2>
    <div class="visual-out">
        <label class="switch2">
            <input type="checkbox" id="toggle" checked />
            <span class="slider2"></span>
        </label>
        <p><span id="modeStatus">Light</span> Mode</p>
    </div>
</div>

<script>
    //check passwords
    function check_password() {
        psw1 = $("#textPassword").val();
        psw2 = $("#textPassword2").val();
        $("#confirmPsw2").empty();
        html_block = "";
        if (psw1 === psw2 && psw1 != '') {
            html_block = '<i class="fa-solid fa-check"></i>';
        } else {
            html_block = '<i class="fa-solid fa-xmark"></i>';
        }
        $("#confirmPsw2").append(html_block)
    }
    
    //dark / light mode
    if(localStorage.getItem("mode") == "dark") {        //check the visual mode state from the local storage variable
        document.getElementById("toggle").checked = false;
        changeMode();
    }
    else {
        document.getElementById("toggle").checked = true;
    }

    document.getElementById("toggle").addEventListener('change', changeMode); //function to change styles

    function changeMode() {
        var status = document.getElementById("modeStatus");
        var body = document.querySelector("body");
        var cookiesLabel = document.getElementById("cookies");
        var cookiesModal = document.getElementById("customizeCookies");
        var confirms = document.querySelectorAll(".input-group-text");

        if(document.getElementById("toggle").checked) {
            localStorage.setItem("mode", "light");
            //light mode
            status.innerHTML = "Light";
            body.style.backgroundColor = "#EDFCFF";
            body.style.color = "#212529";
            cookiesLabel.style.backgroundColor = "#EDFCFF";
            cookiesModal.setAttribute('data-bs-theme', "light");
            confirms.forEach(function (e) {
                e.setAttribute('data-bs-theme', "light");
            });
        }
        else {
            localStorage.setItem("mode", "dark");
            //dark mode
            status.innerHTML = "Dark";
            body.style.backgroundColor = "#222222";
            body.style.color = "white";
            cookiesLabel.style.backgroundColor = "#222222";
            cookiesModal.setAttribute('data-bs-theme', "dark");
            confirms.forEach(function (e) {
                e.setAttribute('data-bs-theme', "dark");
            });
        }
    }

    //notifications
    if(localStorage.getItem("notifications") == "off") {        //check the notifications state from the local storage variable
        document.getElementById("toggleNotif").checked = false;
        changeNotif();
    }
    else {
        document.getElementById("toggleNotif").checked = true;
    }

    document.getElementById("toggleNotif").addEventListener('change', changeNotif); //function to set notification status

    function changeNotif() {
        var notif = document.getElementById("notificationStatus");

        if(document.getElementById("toggleNotif").checked) {
            localStorage.setItem("notifications", "on");
            //notification yes
            notif.innerHTML = "SI";
        }
        else {
            localStorage.setItem("notifications", "off");
            //notification no
            notif.innerHTML = "NO";
        }
    }
</script>

{% endblock %}